# Snowflake ID

대규모 분산 시스템에서 트위티 sequential 한 고유한 문자열을 생성할 수 있다.

- PK 채번 방식을 시퀀스 테이블 또는 내장형 auto increment 기능을 사용할 경우, Multi-Master Replication 디비 환경에서 마이그레이션의 어려움 존재.
-  많은 곳에서 PK 채번시 UUID 문자열로 고유성 대체했다.
  - B+Tree 인덱스 구조에서 sequential PK는 성능상 많은 이점이 따른다.
    - B+Tree 구조의 리프 노드엔 인덱스 키가 정렬되어 저장이 되고 있어, 범위 검색에 탁월한 성능을 보인다. 참고로 PK는 클러스터링 키로 별도의 저장 공간을 지닌다.
    - 따라서 UUID 문자열을 PK 로 선정하게 되면, 순차적인 클러스터링 인덱스를 활용하지 오롯이 못한다는 단점 존재하기에 불필요한 데이터 생성일자로 정렬되어 보고 싶다면 별도의 sequential 한 컬럼을 인덱스로 선정해야된다.

## 구조

Snowflake ID는 총 64비트의 이진수로 구성된다.

```text
{sign bit}{timestamp}{instance}{sequence}
   1bits     41bits    10bits    12bits
```

- 1비트 - 부호 비트
    - 음수 양수 구별
    - 항상 0으로 설정되어 있습니다. 이 비트는 고유 식별자가 음수로 해석되는 것을 방지합니다.
    - 즉, Snowflake ID는 항상 양의 정수로 해석됩니다.
- 41비트 - 타임스탬프
    - 현재 시간 (단위 ms)
    - 기준 시점(Epoch)으로부터의 경과 시간
    - 예를 들어, 기준 시점이 2020년 1월 1일이라면, Snowflake ID를 생성할 때의 시간은 이 기준 시점으로부터 경과한 밀리초 수로 기록됩니다.
    - 이 비트 수는 약 69년 동안(2^41밀리초) 유효한 타임스탬프를 제공할 수 있습니다.
- 10비트 - 기기 ID
    - 데이터 센터 ID와 기계 ID를 포함한 비트입니다.
    - 5비트는 데이터 센터 ID를, 나머지 5비트는 특정 기계 ID를 나타냅니다.
    - 이는 총 1024개(2^10)의 노드(서버 또는 기기)를 지원할 수 있음을 의미합니다.
    - 각 노드는 동일한 시간에 여러 ID를 생성할 수 있습니다.
- 12비트 - 일련번호(Sequence Number)
    - 같은 밀리초 내에 생성된 ID의 일련번호를 나타냅니다.
    - 한 기계가 동일한 밀리초에 최대 4096(2^12)개의 고유 ID를 생성할 수 있습니다.

### VS TSID

Time-Sorted Unique Identifier를 생성하는 java library로, Twitter의 snowflake와 ULID spec을 합쳐 만들었다고 한다.

|             |                          |                               |
|-------------|--------------------------|-------------------------------|
| 특징          | 	TSID	                   | Snowflake ID                  |                                       
| 타임스탬프       | 	55비트 (Epoch 기준)         | 	41비트 (Epoch 기준)              |                      
| 데이터센터/기기 ID | 	데이터센터 ID가 포함되지 않음       | 	10비트 (5비트 데이터 센터, 5비트 기기 ID) | 
| 일련번호/엔트로피	  | 41비트 엔트로피(랜덤 값)	         | 12비트 일련번호                     |                        
| ID 길이       | 	총 96비트 또는 128비트로 구현 가능	 | 총 64비트                        |                        
| 정렬 가능성      | 	시간에 따라 완전히 정렬 가능        | 	시간에 따라 정렬 가능                 |
| 충돌 가능성      | 	데이터센터 ID가 없어 충돌 가능성 높음  | 	일련번호와 기기 ID로 충돌 방지           |
| 사용 사례       | 	정렬이 중요한 시스템	분산          | 시스템 및 대규모 서비스                 | 
| 언어 및 환경     | 	주로 Java 환경에서 사용         | 	다양한 언어와 플랫폼에서 사용             |
| 생성 복잡도      | 	간단한 알고리즘, 외부 서비스 필요 없음  | 	트위터의 시스템에 맞춤화된 설계            |

## Reference

- https://en.wikipedia.org/wiki/Snowflake_ID
- https://velog.io/@ssssujini99/%EA%B0%9C%EB%B0%9C-idPK-%EC%A7%81%EC%A0%91%ED%95%A0%EB%8B%B9-%EC%A0%84%EB%9E%B5-Random-UUID-TSID-%EA%B0%81%EA%B0%81-%EB%B9%84%EA%B5%90%EB%B6%84%EC%84%9D#3-tsid%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-idpk-%ED%95%A0%EB%8B%B9
- https://github.com/sony/sonyflake
