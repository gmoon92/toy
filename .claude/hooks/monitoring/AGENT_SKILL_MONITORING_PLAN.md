# Claude Code 에이전트/스킬 모니터링 및 자동 개선 시스템 계획

> 최종 계획 문서 | 작성일: 2026-02-13 | 버전: 1.0

---

## 목차

1. [개요](#1-개요)
2. [문제 정의](#2-문제-정의)
3. [목표 및 요구사항](#3-목표-및-요구사항)
4. [아키텍처 설계](#4-아키텍처-설계)
5. [구현 계획](#5-구현-계획)
6. [파일 구조](#6-파일-구조)
7. [검증 계획](#7-검증-계획)
8. [부록](#8-부록)

---

## 1. 개요

### 1.1 프로젝트 개요

| 항목        | 내용                                             |
|-----------|------------------------------------------------|
| **프로젝트명** | Claude Code 에이전트/스킬 모니터링 및 자동 개선 시스템           |
| **목적**    | 사용자 학습 자동화, 에이전트/스킬 사용 이력 추적, 문서 품질 자동 평가 및 개선 |
| **구현 방식** | Claude Code 훅(Hooks) 기반 자동화                    |
| **저장 위치** | 프로젝트별 `.claude/hooks/monitoring/logs/` 디렉토리   |

### 1.2 배경

Claude Code CLI를 사용할 때 다음과 같은 문제점이 있습니다:

1. **컨텍스트 단절**: 서브 에이전트(Task 도구)에 작업을 위임하면 메인 컨텍스트에서는 작업 진행 상황을 실시간으로 볼 수 없음
2. **사용 이력 파악 어려움**: 어떤 에이전트나 스킬이 자주 사용되는지, 어떤 패턴이 있는지 추적하기 어려움
3. **문서 개선 지연**: 에이전트/스킬 문서의 문제점을 사용자가 직접 발견해야 하며, 자동화된 피드백 루프가 없음

이 시스템은 훅 기반 자동화를 통해 이러한 문제를 해결합니다.

---

## 2. 문제 정의

### 2.1 현재 문제점

| 문제             | 설명                                  | 영향                  |
|----------------|-------------------------------------|---------------------|
| **블랙박스 작업 위임** | Task 도구로 에이전트를 실행하면 결과가 나올 때까지 대기   | 사용자가 진행 상황을 모름, 불안함 |
| **사용 패턴 불명확**  | 어떤 에이전트/스킬이 얼마나 사용되는지 추적 불가         | 리소스 낭비, 중복 개발       |
| **품질 모니터링 부재** | 에이전트/스킬 문서의 품질이 시간이 지남에 따라 저하될 수 있음 | 사용자 경험 저하           |
| **수동 개선 프로세스** | 문서 개선은 완전히 수동으로 이루어짐                | 개선 속도 느림, 일관성 부족    |

### 2.2 해결 방향

```
┌─────────────────────────────────────────────────────────────────┐
│                      문제 → 해결 방향 매핑                       │
├─────────────────────────────────┬───────────────────────────────┤
│ 문제                            │ 해결 방향                      │
├─────────────────────────────────┼───────────────────────────────┤
│ 블랙박스 작업 위임              │ SubagentStop 훅으로 결과 메인  │
│                                 │ 컨텍스트에 실시간 전달         │
├─────────────────────────────────┼───────────────────────────────┤
│ 사용 패턴 불명확                │ PostToolUse 훅으로 모든        │
│                                 │ Task/Skill 사용을 JSONL로 기록 │
├─────────────────────────────────┼───────────────────────────────┤
│ 품질 모니터링 부재              │ Stop 훅에서 문서 자동 평가     │
│                                 │ 및 메트릭 수집                 │
├─────────────────────────────────┼───────────────────────────────┤
│ 수동 개선 프로세스              │ 개선 제안 자동 생성 및         │
│                                 │ 사용자 승인 후 자동 적용       │
└─────────────────────────────────┴───────────────────────────────┘
```

---

## 3. 목표 및 요구사항

### 3.1 핵심 목표

| 우선순위 | 목표          | 성공 기준                       |
|------|-------------|-----------------------------|
| P0   | 컨텍스트 연속성 제공 | 서브 에이전트 완료 시 메인 컨텍스트에 요약 표시 |
| P0   | 사용 이력 추적    | 세션별로 어떤 에이전트/스킬이 사용되었는지 기록  |
| P1   | 자동 평가 및 제안  | 문서 품질 문제를 자동 감지하고 개선 제안 생성  |
| P1   | 통계 및 분석     | 누적 사용 통계 제공 및 패턴 분석         |
| P2   | 자동 개선 적용    | 사용자 승인 후 개선 제안 자동 적용        |

### 3.2 사용자 요구사항 (결정사항)

| 항목            | 선택                | 근거                           |
|---------------|-------------------|------------------------------|
| **모니터링 수준**   | 주기적 진행 상황 업데이트    | 사용자가 선택 - 더 상세한 모니터링 원함      |
| **자동화 수준**    | 자동 수정 제안 + 사용자 승인 | 사용자가 선택 - 완전 자동화보다 검토 과정 원함  |
| **데이터 저장 위치** | 프로젝트별 저장          | 사용자가 선택 - 프로젝트별 맥락 유지 및 팀 공유 |

---

## 4. 아키텍처 설계

### 4.1 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        메인 Claude Code                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ SubagentStop │  │ PostToolUse  │  │ Stop / SessionEnd    │   │
│  │    Hook      │  │    Hook      │  │      Hooks           │   │
│  └──────┬───────┘  └──────┬───────┘  └──────────┬───────────┘   │
│         │                 │                      │               │
│         ▼                 ▼                      ▼               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              실시간 컨텍스트 브리지                        │    │
│  │     (서브 에이전트 결과 → 메인 컨텍스트 표시)              │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    .claude/hooks/monitoring/.data/                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ sessions/   │  │usage-stats. │  │ improvement-suggestions/│  │
│  │{id}.jsonl   │  │json          │  │ pending/{id}.md         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 훅 이벤트 흐름

```
사용자 입력
    │
    ▼
┌─────────────┐
│ Task 도구   │ ─────────────────┐
│ 실행        │                  │
└─────────────┘                  │
    │                            │
    ▼                            ▼
┌─────────────┐         ┌─────────────────┐
│ 서브에이전트 │         │ PostToolUse 훅  │
│ 실행 시작    │         │ - 이벤트 기록    │
└─────────────┘         │ - 통계 업데이트  │
    │                   └─────────────────┘
    │
    ▼
┌─────────────┐
│ 작업 완료    │
└─────────────┘
    │
    ▼
┌─────────────────┐     ┌─────────────────────────┐
│ SubagentStop 훅 │────▶│ - 결과 요약 메인 컨텍스트  │
│ - 결과 수집      │     │   에 전달                 │
│ - 이벤트 기록    │     │ - 세션 로그 기록           │
└─────────────────┘     └─────────────────────────┘
    │
    │ (세션 종료)
    ▼
┌─────────────┐
│ Stop 훅     │ ─────────────────┐
│ 실행        │                  │
└─────────────┘                  │
    │                            │
    ▼                            ▼
┌─────────────────────┐   ┌─────────────────────────┐
│ 세션 로그 분석       │   │ 개선 제안 생성           │
│ - 사용 패턴 집계     │   │ - 문서 평가              │
│ - 통계 업데이트     │   │ - 제안 파일 생성         │
└─────────────────────┘   └─────────────────────────┘
```

### 4.3 데이터 저장소 구조

```
.claude/hooks/monitoring/.data/
├── sessions/                    # 세션별 이벤트 로그
│   └── {session-id}.jsonl       # JSON Lines 형식
├── agent-evaluations/           # 에이전트 평가 결과
│   └── {agent-name}/
│       └── {timestamp}.json
├── improvement-suggestions/     # 자동 생성된 개선 제안
│   └── pending/                 # 검토 대기 중인 제안
│       └── {suggestion-id}.md
└── usage-stats.json             # 누적 사용 통계
```

#### 4.3.1 세션 로그 형식 (JSONL)

```jsonl
{"timestamp": "2026-02-13T10:00:00Z", "event": "task_invoke", "subagent_type": "Explore", "task_description": "Find API endpoints"}
{"timestamp": "2026-02-13T10:05:00Z", "event": "subagent_stop", "agent_type": "Explore", "result_summary": "Found 5 API endpoints", "transcript_path": "/path/to/transcript"}
{"timestamp": "2026-02-13T10:10:00Z", "event": "skill_invoke", "skill_name": "commit"}
```

#### 4.3.2 사용 통계 형식 (JSON)

```json
{
  "last_updated": "2026-02-13T10:20:00Z",
  "agents": {
    "Explore": {
      "invocation_count": 15,
      "success_rate": 0.93,
      "last_used": "2026-02-13T10:10:00Z"
    }
  },
  "skills": {
    "commit": {
      "invocation_count": 42,
      "last_used": "2026-02-13T10:10:00Z"
    }
  }
}
```

---

## 5. 구현 계획

### 5.1 단계별 구현

#### Phase 1: 기반 구조 (Day 1)

| 작업         | 설명                                                                | 산출물     |
|------------|-------------------------------------------------------------------|---------|
| 디렉토리 구조 생성 | `.claude/hooks/monitoring/`, `.claude/hooks/monitoring/.data/` 생성 | 디렉토리 트리 |
| 공통 라이브러리   | `lib/common.sh` - 락 메커니즘, 로깅, 이벤트 기록                              | 공통 유틸리티 |
| 데이터 스키마 정의 | JSONL 이벤트, 통계 JSON 스키마                                            | 스키마 문서  |

#### Phase 2: 실시간 모니터링 (Day 2-3)

| 작업                 | 설명                  | 핵심 로직                          |
|--------------------|---------------------|--------------------------------|
| `subagent-stop.sh` | 서브 에이전트 종료 시 결과 수집  | 트랜스크립트 파싱 → 요약 생성 → 메인 컨텍스트 전달 |
| `post-tool-use.sh` | Task/Skill 사용 이력 기록 | 도구명 확인 → 이벤트 로깅 → 통계 업데이트      |

#### Phase 3: 주기적 업데이트 (Day 3-4)

| 작업                        | 설명            | 핵심 로직                        |
|---------------------------|---------------|------------------------------|
| `lib/monitor-progress.sh` | 백그라운드 진행 모니터링 | 주기적 트랜스크립트 확인 → 마일스톤 감지 → 알림 |
| 컨텍스트 브리지 개선               | 진행률 계산 및 표시   | 토큰 사용량/메시지 수 기반 진행률 추정       |

#### Phase 4: 자동 평가 및 개선 (Day 4-5)

| 작업                        | 설명             | 평가 기준                       |
|---------------------------|----------------|-----------------------------|
| `stop.sh`                 | 세션 종료 시 분석 트리거 | 세션 로그 분석 → 통계 집계 → 제안 생성 호출 |
| `generate-suggestions.sh` | 문서 자동 평가       | 길이, 예시 포함, 워크플로우, YAML 완성도  |

**에이전트 평가 기준:**

- 문서 길이 ≥ 30줄
- `<example>` 태그 포함 여부
- 워크플로우/프로세스 섹션 존재
- description 필드 100자 이상

**스킬 평가 기준:**

- SKILL.md 길이 ≥ 50줄
- Overview 섹션 존재
- Execution Flow/Workflow 섹션 존재
- references/ 디렉토리 활용

#### Phase 5: 자동 수정 제안 (Day 5-6)

| 작업                         | 설명         | 사용자 흐름                                   |
|----------------------------|------------|------------------------------------------|
| `lib/apply-suggestions.sh` | 제안 적용 스크립트 | 1. 제안 로드 → 2. 수정안 생성 → 3. 사용자 승인 → 4. 적용 |

**사용자 승인 프로세스:**

```
1. 시스템: "다음 개선 제안이 있습니다: [제안 내용]"
2. 시스템: "수정안을 생성했습니다. 검토해주세요: [diff]"
3. 사용자: approve / modify / cancel 선택
4. 시스템: 선택에 따라 적용 또는 폐기
```

#### Phase 6: 통합 및 테스트 (Day 6-7)

| 작업        | 설명                    | 검증 항목    |
|-----------|-----------------------|----------|
| 설정 파일 템플릿 | `settings.json` 예제 작성 | 훅 설정 유효성 |
| README 문서 | 사용 가이드 작성             | 설명 명확성   |
| 호환성 테스트   | 기존 에이전트/스킬과 테스트       | 충돌 여부    |

### 5.2 구현 우선순위

```
P0 (필수) ─────────────────────────────────────────▶
├── Phase 1: 기반 구조
├── Phase 2: 실시간 모니터링
└── 기본 훅 설정 (SubagentStop, PostToolUse)

P1 (중요) ─────────────────────────────────────────▶
├── Phase 4: 자동 평가 및 개선
├── Stop 훅 구현
└── 통계 집계

P2 (향후) ─────────────────────────────────────────▶
├── Phase 3: 주기적 업데이트
├── Phase 5: 자동 수정 제안
└── 고급 분석 기능
```

---

## 6. 파일 구조

### 6.1 전체 파일 트리

```
.claude/
├── hooks/
│   └── monitoring/
│       ├── README.md                 # 사용 가이드
│       ├── settings.json             # 훅 설정 템플릿
│       ├── subagent-stop.sh          # 서브 에이전트 종료 훅
│       ├── post-tool-use.sh          # 도구 사용 후 훅
│       ├── stop.sh                   # 세션 종료 훅
│       └── lib/
│           ├── common.sh             # 공통 유틸리티 (199라인)
│           ├── update-stats.sh       # 통계 업데이트 (67라인)
│           ├── aggregate-stats.sh    # 통계 집계 (69라인)
│           ├── generate-suggestions.sh  # 개선 제안 생성 (256라인)
│           └── apply-suggestions.sh  # 제안 적용 (향후 구현)
│
└── monitoring/
    ├── DIRECTORY_STRUCTURE.md        # 디렉토리 구조 설명
    ├── sessions/                     # 세션별 로그
    ├── agent-evaluations/            # 에이전트 평가 결과
    └── improvement-suggestions/
        └── pending/                  # 대기 중인 개선 제안
```

### 6.2 핵심 파일 설명

| 파일                            | 라인 수 | 설명          | 핵심 기능                     |
|-------------------------------|------|-------------|---------------------------|
| `lib/common.sh`               | 199  | 공통 유틸리티     | 락 메커니즘, 로깅, 이벤트 기록, 문서 평가 |
| `lib/generate-suggestions.sh` | 256  | 개선 제안 생성    | 에이전트/스킬 평가, 마크다운 제안 생성    |
| `subagent-stop.sh`            | 84   | 서브에이전트 종료 훅 | 결과 추출, 메인 컨텍스트 전달         |
| `post-tool-use.sh`            | 76   | 도구 사용 후 훅   | Task/Skill 사용 기록          |
| `stop.sh`                     | 71   | 세션 종료 훅     | 세션 분석, 제안 생성 트리거          |
| `lib/update-stats.sh`         | 67   | 통계 업데이트     | 사용량 증가, 타임스탬프 갱신          |
| `lib/aggregate-stats.sh`      | 69   | 통계 집계       | 세션 분석, 패턴 추출              |

**총 구현된 라인 수: 822 라인**

---

## 7. 검증 계획

### 7.1 테스트 시나리오

#### 시나리오 1: 컨텍스트 연속성

```gherkin
Given 사용자가 Task 도구로 Explore 에이전트를 실행함
When 서브 에이전트가 작업을 완료함
Then 메인 컨텍스트에 완료 알림이 표시됨
And 결과 요약이 제공됨
And 트랜스크립트 링크가 제공됨
```

**검증 명령어:**

```bash
# 세션 로그 확인
cat .claude/hooks/monitoring/.data/sessions/*.jsonl | jq 'select(.event == "subagent_stop")'

# 출력 예시:
# {"timestamp": "2026-02-13T10:05:00Z", "event": "subagent_stop", "agent_type": "Explore", ...}
```

#### 시나리오 2: 사용 이력 추적

```gherkin
Given 사용자가 여러 Task와 Skill을 사용함
When 세션이 종료됨
Then usage-stats.json에 누적 통계가 업데이트됨
And 각 에이전트/스킬별 사용 횟수가 기록됨
```

**검증 명령어:**

```bash
# 통계 확인
cat .claude/hooks/monitoring/.data/usage-stats.json | jq '.agents, .skills'
```

#### 시나리오 3: 자동 개선 제안

```gherkin
Given 에이전트 문서에 예시가 없음
And 사용자가 해당 에이전트를 여러 번 사용함
When 세션이 종료됨
Then improvement-suggestions/pending/에 제안 파일이 생성됨
And 제안에는 예시 추가 권장사항이 포함됨
```

**검증 명령어:**

```bash
# 개선 제안 확인
ls -la .claude/hooks/monitoring/.data/improvement-suggestions/pending/
cat .claude/hooks/monitoring/.data/improvement-suggestions/pending/*.md
```

### 7.2 성능 기준

| 항목       | 기준                    | 측정 방법    |
|----------|-----------------------|----------|
| 훅 실행 시간  | < 100ms (PostToolUse) | 타임스탬프 비교 |
| 훅 실행 시간  | < 1s (SubagentStop)   | 타임스탬프 비교 |
| 로그 파일 크기 | < 10MB/세션             | 파일 크기 확인 |
| 락 대기 시간  | < 5s                  | 타임아웃 설정  |

---

## 8. 부록

### 8.1 Claude Code 훅 시스템 개요

| 이벤트              | 시점              | 용도           |
|------------------|-----------------|--------------|
| **PreToolUse**   | 도구 실행 전         | 검증, 수정, 차단   |
| **PostToolUse**  | 도구 실행 후         | 로깅, 피드백 수집   |
| **SubagentStop** | 서브에이전트 종료 시     | 작업 검증, 결과 수집 |
| **Stop**         | 메인 에이전트 종료 고려 시 | 완성도 확인, 정리   |
| **SessionStart** | 세션 시작 시         | 컨텍스트 로딩      |
| **SessionEnd**   | 세션 종료 시         | 정리, 로깅       |

### 8.2 훅 설정 예시

```json
{
  "hooks": {
    "SubagentStop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PROJECT_DIR}/.claude/hooks/monitoring/subagent-stop.sh",
            "timeout": 30
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Task|Skill",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PROJECT_DIR}/.claude/hooks/monitoring/post-tool-use.sh",
            "timeout": 10
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PROJECT_DIR}/.claude/hooks/monitoring/stop.sh",
            "timeout": 60
          }
        ]
      }
    ]
  }
}
```

### 8.3 에이전트/스킬 문서 구조

#### 에이전트 문서 (`.claude/agents/docs/{name}.md`)

```yaml
---
name: agent-name
description: "에이전트 설명 (최대 1024자)"
color: cyan
model: inherit
---

# 에이전트 설명

## 사용 예시

  <example>
상황: ...
user: "..."
assistant: "..."
  <commentary>...</commentary>
  </example>
```

#### 스킬 문서 (`.claude/skills/{name}/SKILL.md`)

```yaml
---
name: skill-name
description: "스킬 설명 (최대 1024자)"
user-invocable: true
allowed-tools: Read, Write, Bash
---

## Overview
- 핵심 기능 요약

## When to Load References
- 단계별 참조 로드 조건

## Core Principles
- 핵심 원칙 2-4개

## Execution Flow
  1. 단계 1
  2. 단계 2
  3. 단계 3
```

### 8.4 참고 문서

- [Claude Code 훅 개발 가이드](https://code.claude.com/docs/en/hooks)
- [훅 패턴 및 모범 사례](https://code.claude.com/docs/en/hooks-guide)
- [Skill Builder 원칙](.claude/skills/skill-builder/skills/reference/checklist.md)

---

## 결론

이 계획은 Claude Code CLI에서 사용자 학습 자동화 및 에이전트/스킬 모니터링을 구현하기 위한 종합적인 로드맵을 제공합니다.

**현재 구현 상태:**

- ✅ Phase 1 완료: 기반 구조 (822 라인)
- ✅ Phase 2 완료: 실시간 모니터링 핵심 훅
- ⏳ Phase 3-5: 고급 기능 (향후 구현)

**즉시 사용 가능한 기능:**

1. 서브 에이전트 결과 메인 컨텍스트에 표시
2. Task/Skill 사용 이력 JSONL로 기록
3. 에이전트/스킬 문서 자동 평가 및 개선 제안 생성
4. 누적 사용 통계 집계

**설정 방법:**
`.claude/hooks/monitoring/settings.json`의 내용을 `~/.claude/settings.json`에 병합하고 Claude Code를 재시작하세요.

---

*문서 버전: 1.0 | 최종 수정: 2026-02-13*
